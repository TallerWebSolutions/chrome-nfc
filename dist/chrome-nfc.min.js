/*
 * Copyright 2014 Google Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at

 *     http://www.apache.org/licenses/LICENSE-2.0
  
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function DevManager(){this.devs=[],this.enumerators=[]}function MifareClassic(t){this.tag_id=new Uint8Array(t),this.type_name="MIFARE Classic 1K",this.WRITE_COMMAND=160}function NDEF(t,e){this.ndef=[],this.prepending=["","http://www.","https://www.","http://","https://","tel:","mailto:","ftp://anonymous:anonymous@","ftp://ftp.","ftps://","sftp://","smb://","nfs://","ftp://","dav://","news:","telnet://","imap:","rtsp://","urn:","pop:","sip:","sips:","tftp:","btspp://","btl2cpa://","btgoep://","tcpobex://","irdaobex://","file://","urn:epc:id:","urn:epc:tag:","urn:epc:pat:","urn:epc:raw:","urn:epc:","urn:nfc:"],t&&(this.ndef=this.parse(t,e))}function NFC(){function t(t){for(var e=new NDEF,n=0;n<t.length;n++)e.add(t[n]);return e}function e(t,e,n){void 0==n&&(n=9999999999),t.wait_for_passive_target(n,function(t,n,r){return t?(console.log("NFC.wait_for_passive_target() = "+t),e(t),t):(console.log("[DEBUG] nfc.wait_for_passive_target: "+n+" with ID: "+NFC.util.BytesToHex(new Uint8Array(r))),void e(t,n,r))})}this.findDevices=function(t){var e=new usbSCL3711;window.setTimeout(function(){e.open(0,function(n){return n?(console.log("NFC.device.open() = "+n),t([]),n):(e.vendorId=e.dev.dev.vendorId,e.productId=e.dev.dev.productId,void t([e]))},function(){console.debug("device.onclose() is called.")})},1e3)},this.read=function(t,n,r){var o=n.timeout,i=r;e(t,function(e,n,r){var o=new Tag(n,r);return o?void o.read(t,function(t,e){if(t)return console.log("NFC.read.read() = "+t),i(null,null),t;var r=new NDEF(e);i(n+".ndef",r)}):void console.log("nfc.read: unknown tag_type: "+n)},o)},this.read_logic=function(t,n,r,o){var i=o;e(t,function(e,o,a){var s=new Tag(o,a);return s?s.read_logic?void s.read_logic(t,n,r,function(t){i(0,t)}):void console.log("nfc.read: "+o+" doesn't support reading logic block"):void console.log("nfc.read_logic: unknown tag_type: "+o)})},this.wait_for_tag=function(t,n,r){var o=r,i=function(n){e(t,function(t,e,r){t>=0?o(e,r):n>0?window.setTimeout(function(){i(n-250)},250):o(null,null)})};i(n)},this.write=function(n,r,o,i){e(n,function(e,i,a){var s=new Tag(i,a);if(!s)return void console.log("nfc.write: unknown tag_type: "+i);var c=t(r.ndef);s.write(n,c.compose(),function(t){o(t)})},i)},this.write_logic=function(t,n,r,o){var i=o;e(t,function(e,o,a){var s=new Tag(o,a);return s?s.write_logic?void s.write_logic(t,n,r,function(t){i(t)}):void console.log("nfc.read: "+o+" doesn't support reading logic block"):void console.log("nfc.write_logic: unknown tag_type: "+o)})},this.write_physical=function(t,n,r,o,i){var a=i;e(t,function(e,i,s){var c=new Tag(i,s);return c?c.write_physical?void c.write_physical(t,n,r,o,function(t){a(t)}):void console.log("nfc.read: "+i+" doesn't support reading physical block"):void console.log("nfc.write_physical: unknown tag_type: "+i)})},this.emulate_tag=function(n,r,o,i){void 0==i&&(i=9999999999),e(n,function(){var e=new TT2,a=t(r.ndef);e.emulate(n,a,i,function(t){o(t)})},i)}}function usbSCL3711(){this.dev=null,this.cid=16777215&++scl3711_id,this.rxframes=[],this.rxcb=null,this.onclose=null,this.detected_tag=null,this.auth_key=null,this.authed_sector=null,this.KEYS=[new Uint8Array([255,255,255,255,255,255]),new Uint8Array([211,247,211,247,211,247]),new Uint8Array([160,161,162,163,164,165])],this.strerror=function(t){var e={1:"time out, the target has not answered",2:"checksum error during rf communication",3:"parity error during rf communication",4:"erroneous bit count in anticollision",5:"framing error during mifare operation",6:"abnormal bit collision in 106 kbps anticollision",7:"insufficient communication buffer size",9:"rf buffer overflow detected by ciu",10:"rf field not activated in time by active mode peer",11:"protocol error during rf communication",13:"overheated - antenna drivers deactivated",14:"internal buffer overflow",16:"invalid command parameter",18:"unsupported command from initiator",19:"format error during rf communication",20:"mifare authentication error",24:"not support NFC secure",25:"i2c bus line is busy",35:"wrong uid check byte (14443-3)",37:"command invalid in current dep state",38:"operation not allowed in this configuration",39:"not acceptable command due to context",41:"released by initiator while operating as target",42:"card ID does not match",43:"the card previously activated has disapperaed",44:"Mismatch between NFCID3 initiator and target in DEP 212/424 kbps",45:"Over-current event has been detected",46:"NAD missing in DEP frame",47:"deselected by initiator while operating as target",49:"initiator rf-off state detected in passive mode",127:"pn53x application level error"};return t in e?"["+t+"] "+e[t]:"Unknown error: "+t}}function SHA256(){this._buf=new Array(64),this._W=new Array(64),this._pad=new Array(64),this._k=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],this._pad[0]=128;for(var t=1;64>t;++t)this._pad[t]=0;this.reset()}function Tag(t,e){switch(t){case"tt2":return new TT2(e);case"mifare_classic":return new MifareClassic(e)}return null}function TT2(t){this.tag_id=new Uint8Array(t),this.type_name=null,this.lock_contorl=[]}function llSCL3711(t,e){this.dev=t,this.txqueue=[],this.clients=[],this.acr122=e,this.endpoint=e?2:4,this.readLoop()}var base64=function(){this.inmap=[0,0,0,0,0,0,0,0,0,0,0,0,0,63,0,0,53,54,55,56,57,58,59,60,61,62,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,0,0,0,0,64,0,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,0,0,0,0,0],this.encode=function(t,e,n){e="undefined"==typeof e?t.length:e,n="undefined"==typeof n?!0:n;for(var r=n?"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o="",i=0,a=0,s=0;e--;)for(a<<=8,a|=t[s++],i+=8;i>=6;){var c=a>>i-6&63;o+=r.charAt(c),i-=6}if(i){a<<=8,i+=8;var c=a>>i-6&63;o+=r.charAt(c)}if(!n)for(;o.length%4;)o+="=";return o},this.decode=function(t){for(var e=[],n=0,r=0,o=0;o<t.length;++o){var i=t.charCodeAt(o);if(32>i||i>127||!this.inmap[i-32])return[];n<<=6,n|=this.inmap[i-32]-1,r+=6,r>=8&&(e.push(n>>r-8&255),r-=8)}return e}}();DevManager.prototype.dropDevice=function(t){var e=this.devs;this.devs=[];for(var n=!1,r=0;r<e.length;++r)e[r]!==t?this.devs.push(e[r]):n=!0;n&&(t.dev&&(chrome.usb.releaseInterface(t.dev,0,function(){console.log(NFC.util.fmt("released"))}),chrome.usb.closeDevice(t.dev,function(){console.log(NFC.util.fmt("closed"))}),t.dev=null),console.log(this.devs.length+" devices remaining"))},DevManager.prototype.closeAll=function(t){console.debug("DevManager.closeAll() is called");for(var e=this.devs.slice(0),n=0;n<e.length;++n)e[n].close();t&&t()},DevManager.prototype.enumerate=function(t){function e(t,e){var r=0;if(t&&0!=t.length)console.log(NFC.util.fmt("Enumerated "+t.length+" devices")),console.log(t),r=t.length;else{if(!t){console.log("Lacking permission?");do!function(t){t&&window.setTimeout(function(){t(-666)},0)}(n.enumerators.shift());while(n.enumerators.length);return}console.log("No devices found")}for(var o=0;r>o;++o)!function(t,o){window.setTimeout(function(){chrome.usb.claimInterface(t,0,function(){if(console.log(NFC.util.fmt("claimed")),console.log(t),n.devs.push(new llSCL3711(t,e)),o==r-1){var i=new Uint8Array(4);for(i[0]=r>>24,i[1]=r>>16,i[2]=r>>8,i[3]=r;n.enumerators.length;)!function(t){window.setTimeout(function(){t&&t(0,i)},20)}(n.enumerators.shift())}})},0)}(t[o],o)}var n=this;if(0!=this.devs.length){var r=new Uint8Array(4);r[0]=this.devs.length>>24,r[1]=this.devs.length>>16,r[2]=this.devs.length>>8,r[3]=this.devs.length,t&&t(0,r)}else{var o=0==this.enumerators.length;this.enumerators.push(t),o&&window.setTimeout(function(){chrome.usb.findDevices({vendorId:1254,productId:21905},function(t){t&&0!=t.length?e(t,!1):chrome.usb.findDevices({vendorId:1839,productId:8704},function(t){t&&0!=t.length&&e(t,!0)})})},0)}},DevManager.prototype.open=function(t,e,n){var r=this;this.enumerate(function(){var o=r.devs[t];o&&o.registerClient(e),n&&n(o||null)})},DevManager.prototype.close=function(t,e){for(var n=this.devs,r=0;r<n.length;++r){var o=n[r];o.deregisterClient(e)}},DevManager.DevManager.defaultCallback=function(t,e){var n="DevManager.defaultCallback("+t;e&&(n+=", "+NFC.util.BytesToHex(new Uint8Array(e))),n+=")",console.log(NFC.util.fmt(n))};var devManager=new DevManager;MifareClassic.prototype.log2sec=function(t){return 2>t?0:Math.floor((t-2)/3)+1},MifareClassic.prototype.log2phy=function(t){if(2>t)return t+1;var e=this.log2sec(t);return 4*e+(t-2)%3},MifareClassic.prototype.mif_calc_crc8=function(t){for(var e=199,n=0;n<t.length;n++){e^=t[n];for(var r=0;8>r;r++)128&e?e=e<<1^29:e<<=1}return e},MifareClassic.prototype.mif_calc_crc16=function(t){for(var e=51084,n=0;n<t.length;n++){e^=t[n]<<8;for(var r=0;8>r;r++)32768&e?e=e<<1^4129:e<<=1}return e},MifareClassic.prototype.copy_auth_keys=function(t,e){for(var n=0;6>n;n++)t[n]=e.auth_key[n];for(var n=0;6>n;n++)t[n+10]=255;return t},MifareClassic.prototype.read_physical=function(t,e,n,r){function o(t,e,n){if(3==t&&105!=e[57]){var r;for(r=0;3==e[18+2*r+0]&&225==e[18+2*r+1];r++);var o=4*(r+1);return n>o?o:n}return n}function i(t){var e=t;c.publicAuthentication(e,function(t){return t?s(t):void c.read_block(e,function(t,n){if(t)return s(t);var n=new Uint8Array(n);return e%4==3&&(n=a.copy_auth_keys(n,c)),u=NFC.util.concat(u,n),l=o(e,u,l),e+1>=l?s(u):i(e+1,r)})})}var a=this,s=r,c=t,u=new Uint8Array,l=64;null!=n&&(l=e+n),i(e)},MifareClassic.prototype.read=function(t,e){var n=this;e||(e=DevManager.defaultCallback);{var r=e;new Uint8Array}n.read_physical(t,0,null,function(t){for(var e=0;e<Math.ceil(t.length/16);e++)console.log(NFC.util.fmt("[DEBUG] Sector["+NFC.util.BytesToHex([e])+"] "+NFC.util.BytesToHex(t.subarray(16*e,16*e+16))));var n=t[57];if(105==n)console.log("[DEBUG] Sector 0 is non-personalized (0x69).");else{var o;for(o=0;3==t[18+2*o+0]&&225==t[18+2*o+1];o++);for(var i=new Uint8Array,e=1;o>=e;e++)i=NFC.util.concat(i,t.subarray(64*e,64*e+48));for(var e=0;e<i.length;e++)switch(i[e]){case 0:console.log("[DEBUG] NULL TLV.");break;case 254:return void console.log("[DEBUG] Terminator TLV.");case 3:var a=i[e+1];return a+2>i.length&&console.log("[WARN] Vlen:"+a+" > totla len:"+i.length),r(0,new Uint8Array(i.subarray(e+2,e+2+a)).buffer);default:return void console.log("[ERROR] Unsupported TLV: "+NFC.util.BytesToHex(i[0]))}}})},MifareClassic.prototype.read_logic=function(t,e,n,r){function o(e,n){var r=e,c=n;return 0>=c?a(s):void i.read_physical(t,i.log2phy(e),1,function(t){s=NFC.util.concat(s,t),o(r+1,c-1)})}var i=this,a=r,s=new Uint8Array;o(e,n)},MifareClassic.prototype.compose=function(t){for(var e=this,n=new Uint8Array([3,t.length]),r=new Uint8Array([254]),o=NFC.util.concat(n,NFC.util.concat(new Uint8Array(t),r)),i=Math.ceil(o.length/48),a=new Uint8Array,s=0;i>s;s++){a=NFC.util.concat(a,o.subarray(48*s,48*(s+1)));var c;c=new Uint8Array(s+1==i?48-o.length%48:0),a=NFC.util.concat(a,c),a=NFC.util.concat(a,new Uint8Array([211,247,211,247,211,247,127,7,136,64,255,255,255,255,255,255]))}for(var u=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,225,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,160,161,162,163,164,165,120,119,136,193,255,255,255,255,255,255]),s=0;i>s;s++)u[16+2*(s+1)+0]=3,u[16+2*(s+1)+1]=225;u[16]=e.mif_calc_crc8(u.subarray(17,48));var l=NFC.util.concat(u,a);return l},MifareClassic.prototype.write_physical=function(t,e,n,r,o){function i(t){if(t)return u(t);var e=c.subarray(0,16);a.write_block(s,e,function(t){return t?u(t):void l.write_physical(a,s+1,n,c.subarray(16),u)},l.WRITE_COMMAND)}var a=t,s=e,c=r,u=o,l=this;return 0==c.length?u(0):(c.length<16&&(c=NFC.util.concat(c,new Uint8Array(16-c.length))),void(null==n?a.publicAuthentication(s,i):a.privateAuthentication(s,n,i)))},MifareClassic.prototype.write=function(t,e,n){var r=this;n||(n=DevManager.defaultCallback);var o=n,i=r.compose(new Uint8Array(e)),a=t,s=Math.ceil(i.length/16);return s>64?(console.log("write Classic() card is too big (max: 1024 bytes): "+i.length),o(3003)):void r.write_physical(a,1,null,i.subarray(16),o)},MifareClassic.prototype.write_logic=function(t,e,n,r){function o(t,e,n){var r=t,s=e,c=n;return 0==c.length?a(0):void i.write_physical(r,i.log2phy(s),null,c.subarray(0,16),function(t){if(t)return a(t);var e=4*i.log2sec(s)+3;r.read_block(e,function(t,n){if(t)return a(t);var n=new Uint8Array(n);n=i.copy_auth_keys(n,r),n[9]=3==e?193:64,r.write_block(e,n,function(){return s+=1,c=c.subarray(16),o(r,s,c)},i.WRITE_COMMAND)})})}var i=this,a=r;o(t,e,n)},MifareClassic.prototype.emulate=function(t,e,n,r){var o=this.compose(new Uint8Array(e.compose()));return t.emulate_tag(o,n,r)},NDEF.prototype.parse=function(t,e){var n,r=[];for(t=new Uint8Array(t),n=0;n<t.length;n++){var o,i,a,s,c,u=(128&t[n])>>7,l=(64&t[n])>>6,f=((32&t[n])>>5,(16&t[n])>>4),h=(8&t[n])>>3,p=(7&t[n])>>0,d=t[n+1],g=4+d;if(f?(o=3,g=3+d,s=t[n+2]):(o=6,g=6+d,s=256*(256*(256*t[n+2]+t[n+3])+t[n+4])+t[n+5]),h){o+=1;var y=t[n+o-1];g+=1+y;var v=o+d;i=t.subarray(n+v,n+v+y)}else i=null;switch(a=new Uint8Array(t.subarray(n+o,n+o+d)),c=new Uint8Array(t.subarray(n+g,n+g+s)),console.log("raw[i]: "+t[n]),console.log("MB: "+u),console.log("ME: "+l),console.log("SR: "+f),console.log("IL: "+h),console.log("TNF: "+p),console.log("type_off: "+o),console.log("type_len: "+d),console.log("payload_off: "+g),console.log("payload_len: "+s),console.log("type: "+NFC.util.BytesToHex(a)),console.log("payload: "+NFC.util.BytesToHex(c)),p){case 1:r.push(this.parse_RTD(a[0],c));break;case 2:r.push(this.parse_MIME(a,c));break;case 4:r.push(this.parse_ExternalType(a,c));break;default:console.error("Unsupported TNF: "+p)}if(n=g+s-1,l)break}return e&&e(r),r},NDEF.prototype.compose=function(){for(var t=new Uint8Array,e=[],n=0;n<this.ndef.length;n++){var r=this.ndef[n];switch(r.type){case"TEXT":case"Text":e.push({TNF:1,TYPE:new Uint8Array([84]),PAYLOAD:this.compose_RTD_TEXT(r.lang,r.text)});break;case"URI":e.push({TNF:1,TYPE:new Uint8Array([85]),PAYLOAD:this.compose_RTD_URI(r.uri)});break;case"MIME":e.push({TNF:2,TYPE:new Uint8Array(NFC.util.StringToBytes(r.mime_type)),PAYLOAD:this.compose_MIME(r.payload)});break;case"AAR":e.push({TNF:4,TYPE:new Uint8Array(NFC.util.StringToBytes("android.com:pkg")),PAYLOAD:this.compose_AAR(r.aar)});break;default:console.error("Unsupported RTD type:"+r.type)}}for(var n=0;n<e.length;n++){var o=16|e[n].TNF;o|=0==n?128:0,o|=n==e.length-1?64:0;var i=e[n].TYPE,a=e[n].PAYLOAD;t=NFC.util.concat(t,[o,i.length,a.length]),t=NFC.util.concat(t,i),t=NFC.util.concat(t,a)}return t.buffer},NDEF.prototype.add=function(t){switch("uri"in t?t.type="URI":"text"in t?t.type="TEXT":"aar"in t?t.type="AAR":"payload"in t&&(t.type="MIME"),t.type){case"TEXT":case"Text":if("encoding"in t||(t.encoding="utf8"),"lang"in t||(t.lang="en"),"text"in t)return this.ndef.push(t),!0;break;case"URI":if("uri"in t)return this.ndef.push(t),!0;break;case"MIME":if("mime_type"in t&&"payload"in t)return this.ndef.push(t),!0;case"AAR":if("aar"in t)return this.ndef.push(t),!0;break;default:console.log("Unsupported RTD type:"+t.type)}return!1},NDEF.prototype.parse_RTD=function(t,e){switch(t){case 84:return this.parse_RTD_TEXT(e);case 85:return this.parse_RTD_URI(e);default:console.log("Unsupported RTD type: "+t)}},NDEF.prototype.parse_MIME=function(t,e){return{type:"MIME",mime_type:NFC.util.BytesToString(t),payload:NFC.util.BytesToString(e)}},NDEF.prototype.compose_MIME=function(t){return new Uint8Array(NFC.util.StringToBytes(t))},NDEF.prototype.parse_AAR=function(t){return{type:"AAR",payload:NFC.util.BytesToString(t)}},NDEF.prototype.parse_ExternalType=function(t,e){return"android.com:pkg"==NFC.util.BytesToString(t)?this.parse_AAR(e):{type:t,payload:NFC.util.BytesToString(e)}},NDEF.prototype.compose_AAR=function(t){return new Uint8Array(NFC.util.StringToBytes(t))},NDEF.prototype.parse_RTD_TEXT=function(t){var e=(128&t[0])>>7,n=63&t[0],r=t.subarray(1,1+n),o=t.subarray(1+n,t.length);return{type:"Text",encoding:e?"utf16":"utf8",lang:NFC.util.BytesToString(r),text:NFC.util.BytesToString(o)}},NDEF.prototype.compose_RTD_TEXT=function(t,e){var n=t.length;return n=n>63?63:n,new Uint8Array([n].concat(NFC.util.StringToBytes(t.substring(0,n))).concat(NFC.util.StringToBytes(e)))},NDEF.prototype.parse_RTD_URI=function(t){return{type:"URI",uri:this.prepending[t[0]]+NFC.util.BytesToString(t.subarray(1,t.length))}},NDEF.prototype.compose_RTD_URI=function(t){for(var e,n=-1,r=0;r<this.prepending.length;r++)t.substring(0,this.prepending[r].length)==this.prepending[r]&&this.prepending[r].length>n&&(e=r,n=this.prepending[r].length);return new Uint8Array([e].concat(NFC.util.StringToBytes(t.substring(n))))},chrome.nfc=NFC();var scl3711_id=0;usbSCL3711.prototype.notifyFrame=function(t){0!=this.rxframes.length?t&&window.setTimeout(t,0):this.rxcb=t},usbSCL3711.prototype.receivedFrame=function(t){if(!this.rxframes)return!1;this.rxframes.push(t);var e=this.rxcb;return this.rxcb=null,e&&window.setTimeout(e,0),!0},usbSCL3711.prototype.readFrame=function(){if(0==this.rxframes.length)throw"rxframes empty!";var t=this.rxframes.shift();return t},usbSCL3711.prototype.read=function(t,e){function n(t,e,n){i&&(window.clearTimeout(i),i=null);var r=a;r&&(a=null,window.setTimeout(function(){r(t,e,n)},0))}function r(){a&&i&&(console.log(NFC.util.fmt("["+s.cid.toString(16)+"] timeout!")),i=null)}function o(){if(a&&i){var t=new Uint8Array(s.readFrame());if(6==t.length&&0==t[0]&&0==t[1]&&255==t[2]&&0==t[3]&&255==t[4]&&0==t[5])return void s.notifyFrame(o);if(t.length>10&&(128==t[0]?t=NFC.util.concat(new Uint8Array([0,0,255,1,255]),new Uint8Array(t.subarray(10))):131==t[0]&&(t=NFC.util.concat(new Uint8Array([0,0,255,1,255]),new Uint8Array(t.subarray(10))))),7==t.length){if(144==t[5]&&0==t[6])return void n(0,t.buffer);if(99==t[5]&&0==t[6])return void n(2730,t.buffer)}else if(t.length>6&&0==t[0]&&0==t[1]&&255==t[2]&&t[3]+t[4]==256){if(213==t[5]&&65==t[6])return void(0==t[7]?n(0,new Uint8Array(t.subarray(8,t.length-2)).buffer):console.log("ERROR: InDataExchange reply status = "+s.strerror(t[7])));if(213==t[5]&&141==t[6])return void n(0,new Uint8Array(t.subarray(8,t.length-2)).buffer);if(213==t[5]&&137==t[6])return void(0==t[7]?n(0,new Uint8Array(t.subarray(8,t.length-2)).buffer):console.log("ERROR: TgGetInitiatorCommand reply status = "+s.strerror(t[7])));if(213==t[5]&&145==t[6])return void(0==t[7]?n(0,new Uint8Array(t.subarray(8,t.length-2)).buffer):console.log("ERROR: TgResponseToInitiator reply status = "+s.strerror(t[7])));if(213==t[5]&&51==t[6])return void n(0,new Uint8Array(t.subarray(7,t.length-2)).buffer);if(213==t[5]&&75==t[6]){if(1!=t[7]||1!=t[8])return void console.log("DEBUG: found "+t[7]+" target, tg="+t[8]);console.log("DEBUG: InListPassiveTarget SENS_REQ(ATQA)=0x"+(256*t[9]+t[10]).toString(16)+", SEL_RES(SAK)=0x"+t[11].toString(16));var e=t[12],r=new Uint8Array(t.subarray(13,13+e)).buffer;if(console.log("DEBUG: tag_id: "+NFC.util.BytesToHex(new Uint8Array(r))),0==t[9]&&68==t[10])return console.log("DEBUG: found Mifare Ultralight (106k type A)"),s.detected_tag="Mifare Ultralight",s.authed_sector=null,s.auth_key=null,void n(0,"tt2",r);if(0==t[9]&&4==t[10])return console.log("DEBUG: found Mifare Classic 1K (106k type A)"),s.detected_tag="Mifare Classic 1K",s.authed_sector=null,s.auth_key=null,void n(0,"mifare_classic",r)}}n(2184,t.buffer)}}if(!this.dev)return void e(1);var i=null,a=e,s=this;i=window.setTimeout(r,1e3*t),s.notifyFrame(o)},usbSCL3711.prototype.write=function(t){this.dev.writeFrame(t)},usbSCL3711.prototype.exchange=function(t,e,n){this.write(t),this.read(e,n)},usbSCL3711.prototype.acr122_reset_to_good_state=function(t){var e=this,n=t;e.exchange(new Uint8Array([0,0,255,0,255,0]).buffer,1,function(t){t&&console.warn("[FIXME] acr122_reset_to_good_state: rc = "+t),e.exchange(new Uint8Array([98,0,0,0,0,0,0,1,0,0]).buffer,10,function(t){t&&console.warn("[FIXME] icc_power_on: rc = "+t),console.log("[DEBUG] icc_power_on: turn on the device power"),n&&window.setTimeout(function(){n(0)},100)})})},usbSCL3711.prototype.acr122_set_buzzer=function(t,e){var n=this,r=e,o=t?255:0;n.exchange(new Uint8Array([107,5,0,0,0,0,0,0,0,0,255,0,82,o,0]).buffer,1,function(t,e){r&&r(t,e)})},usbSCL3711.prototype.acr122_load_authentication_keys=function(t,e,n){var r=this,o=n;null==t?t=r.KEYS[0]:"object"!=typeof t&&(t=r.KEYS[t]);var i=new Uint8Array([107,11,0,0,0,0,0,0,0,0,255,130,0,e,6]);i=NFC.util.concat(i,t),r.exchange(i.buffer,1,function(n,r){console.log("[DEBUG] acr122_load_authentication_keys(loc: "+e+", key: "+NFC.util.BytesToHex(t)+") = "+n),o&&o(n,r)})},usbSCL3711.prototype.acr122_authentication=function(t,e,n,r){var o=this,i=r;o.exchange(new Uint8Array([107,10,0,0,0,0,0,0,0,0,255,134,0,0,5,1,0,t,n,e]).buffer,1,function(r,o){console.log("[DEBUG] acr122_authentication(loc: "+e+", type: "+n+", block: "+t+") = "+r),i&&i(r,o)})},usbSCL3711.prototype.publicAuthentication=function(t,e){function n(e){var a=e;return a>=3?void(o&&o(4095)):void r.acr122_load_authentication_keys(a,0,function(e){e||r.acr122_authentication(t,0,96,function(e){return e?n(a+1):(r.authed_sector=i,r.auth_key=r.KEYS[a],void r.acr122_load_authentication_keys(r.KEYS[0],1,function(){r.acr122_authentication(t,1,97,function(t,e){o&&o(t,e)})}))})})}var r=this,o=e,i=Math.floor(t/4);"Mifare Classic 1K"==r.detected_tag&&r.dev&&r.dev.acr122&&r.authed_sector!=i?(console.log("[DEBUG] Public Authenticate sector "+i),n(0)):o&&o(0,null)},usbSCL3711.prototype.privateAuthentication=function(t,e,n){var r=this,o=n,i=Math.floor(t/4);"Mifare Classic 1K"==r.detected_tag&&r.dev&&r.dev.acr122&&r.authed_sector!=i?(console.log("[DEBUG] Private Authenticate sector "+i),r.acr122_load_authentication_keys(e,1,function(){r.acr122_authentication(t,1,97,function(t,e){return t?(console.log("KEY B AUTH ERROR"),t):void(o&&o(t,e))})})):o&&o(0,null)},usbSCL3711.prototype.acr122_set_timeout=function(t,e){var n=this,r=e,o=Math.ceil(t/5);o>=255&&(o=255),console.log("[DEBUG] acr122_set_timeout(round up to "+5*o+" secs)"),n.exchange(new Uint8Array([107,5,0,0,0,0,0,0,0,0,255,0,65,o,0]).buffer,1,function(t,e){r&&r(t,e)})},usbSCL3711.prototype.open=function(t,e,n){this.rxframes=[],this.onclose=n,this.cid&=16777215,this.cid|=t+1<<24;var r=this,o=e;devManager.open(t,this,function(t){r.dev=t;var e=null!=r.dev?0:1;r.dev&&r.dev.acr122?r.acr122_reset_to_good_state(function(t){return t?(console.error("[ERROR] acr122_reset_to_good_state() returns "+t),o?o(t):null):void r.acr122_set_buzzer(!1,function(t){return t?(console.error("[ERROR] acr122_reset_to_good_state() returns "+t),o?o(t):null):void(o&&o(e))})}):o&&o(e)})},usbSCL3711.prototype.close=function(){function t(){n.exchange(n.makeFrame(68,new Uint8Array([1])),1,function(){n.exchange(n.makeFrame(82,new Uint8Array([1])),1,function(){})})}function e(){n.rxframes=null,n.dev&&(devManager.close(n.dev,n),n.dev=null)}var n=this;t(e)},usbSCL3711.prototype.makeFrame=function(t,e){var n=new Uint8Array(e?e:[]),r=new Uint8Array(n.length+2),o=n.length+2;if(this.dev.acr122){var i=7+n.length,a=new Uint8Array(10);a[0]=107,a[1]=i>>0&255,a[2]=i>>8&255,a[3]=i>>16&255,a[4]=i>>24&255,a[5]=0,a[6]=0,a[7]=0,a[8]=0,a[9]=0;var s=new Uint8Array(5);s[0]=255,s[1]=0,s[2]=0,s[3]=0,s[4]=n.length+2,c=NFC.util.concat(a,s)}else{var c=new Uint8Array(8);c[0]=0,c[1]=0,c[2]=255,c[3]=255,c[4]=255,c[5]=o>>>8,c[6]=255&o,c[7]=256-(c[5]+c[6]&255)}r[0]=212,r[1]=t;for(var u=r[0]+r[1],l=0;l<n.length;++l)r[2+l]=n[l],u+=n[l];var f=null;return this.dev.acr122?f=new Uint8Array([]):(f=new Uint8Array(2),f[0]=256-(255&u),f[1]=0),NFC.util.concat(NFC.util.concat(c,r),f).buffer},usbSCL3711.prototype.wait_for_passive_target=function(t,e){function n(t,e){r.detected_tag=null,r.exchange(r.makeFrame(74,new Uint8Array([1,0])),t,e)}var r=this;e||(e=DevManager.defaultCallback),r.dev.acr122?r.acr122_set_timeout(t,function(){n(t,e)}):n(t,e)},usbSCL3711.prototype.read_block=function(t,e){var n=this,r=e;e||(e=DevManager.defaultCallback);var o=new Uint8Array(2);o[0]=48,o[1]=t,n.apdu(o,function(t,e){r(t,e)})},usbSCL3711.prototype.emulate_tag=function(t,e,n){function r(){var t=new Uint8Array([1,4,0,0,176,11,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),e=i.makeFrame(140,t);i.exchange(e,a,function(t,e){return 0!=t?void o(t):(console.log("Emulated as a tag, reply is following:"),void s(new Uint8Array(e)))})}n||(n=DevManager.defaultCallback);var o=n,i=this,a=e,s=function(e){switch(e[0]){case 48:var n=e[1];console.log("recv TT2.READ(blk_no="+n+")");var r=t.subarray(4*n,4*n+16);r.length<16&&(r=NFC.util.concat(r,new Uint8Array(16-r.length)));var c=i.makeFrame(144,r);i.exchange(c,a,function(t){if(t)return console.log("exchange(): "+t),t;var e=i.makeFrame(136,[]);i.exchange(e,a,function(t,e){return t?(console.log("exchange(): "+t),t):void s(new Uint8Array(e))})});break;case 80:console.log("recv TT2.HALT received."),o(0);break;default:console.log("Unsupported TT2 tag: "+e[0]),o(2457)}};i.dev.acr122?i.exchange(new Uint8Array([107,5,0,0,0,0,0,0,0,0,255,0,81,0,0]).buffer,1,function(){i.exchange(new Uint8Array([107,9,0,0,0,0,0,0,0,0,255,0,0,0,4,212,50,1,0]).buffer,1,function(t){return 0!=t?void o(t):void i.acr122_set_timeout(e,function(t){return 0!=t?void o(t):void r()})})}):r()},usbSCL3711.prototype.write_block=function(t,e,n,r){var o=n;null==r&&(r=162);var i=new Uint8Array(2+e.length);i[0]=r,i[1]=t;for(var a=0;a<e.length;a++)i[2+a]=e[a];this.apdu(i,function(t){o(t)})},usbSCL3711.prototype.apdu=function(t,e,n){e||(e=DevManager.defaultCallback);for(var r=new Uint8Array(this.makeFrame(64,NFC.util.concat([1],t))),o=0;o<r.length;o+=64)this.dev.writeFrame(new Uint8Array(r.subarray(o,o+64)).buffer);n?e(0,null):this.read(3,function(t,n,r){if(0!=t)return void e(t);var o=new Uint8Array(n);if(r){if(o.length<2)return void e(1638);var i=256*o[o.length-2]+o[o.length-1];e(36864==i?0:i,new Uint8Array(o.subarray(0,o.length-2)).buffer)}else e(0,o.buffer)})},SHA256.prototype.reset=function(){this._chain=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],this._inbuf=0,this._total=0},SHA256.prototype._compress=function(t){function e(t,e){return t<<32-e|t>>>e}for(var n=this._W,r=this._k,o=0;64>o;o+=4){var i=t[o]<<24|t[o+1]<<16|t[o+2]<<8|t[o+3];n[o/4]=i}for(var o=16;64>o;++o){var a=e(n[o-15],7)^e(n[o-15],18)^n[o-15]>>>3,s=e(n[o-2],17)^e(n[o-2],19)^n[o-2]>>>10;n[o]=n[o-16]+a+n[o-7]+s&4294967295}for(var c=this._chain[0],u=this._chain[1],l=this._chain[2],f=this._chain[3],h=this._chain[4],p=this._chain[5],d=this._chain[6],g=this._chain[7],o=0;64>o;++o){var y=e(c,2)^e(c,13)^e(c,22),v=c&u^c&l^u&l,_=y+v&4294967295,w=e(h,6)^e(h,11)^e(h,25),m=h&p^~h&d,b=g+w+m+r[o]+n[o]&4294967295;g=d,d=p,p=h,h=f+b&4294967295,f=l,l=u,u=c,c=b+_&4294967295}this._chain[0]+=c,this._chain[1]+=u,this._chain[2]+=l,this._chain[3]+=f,this._chain[4]+=h,this._chain[5]+=p,this._chain[6]+=d,this._chain[7]+=g},SHA256.prototype.update=function(t,e){e||(e=t.length),this._total+=e;for(var n=0;e>n;++n)this._buf[this._inbuf++]=t[n],64==this._inbuf&&(this._compress(this._buf),this._inbuf=0)},SHA256.prototype.updateRange=function(t,e,n){this._total+=n-e;for(var r=e;n>r;++r)this._buf[this._inbuf++]=t[r],64==this._inbuf&&(this._compress(this._buf),this._inbuf=0)},SHA256.prototype.digest=function(){for(var t=0;t<arguments.length;++t)this.update(arguments[t]);var e=new Array(32),n=8*this._total;this._inbuf<56?this.update(this._pad,56-this._inbuf):this.update(this._pad,64-(this._inbuf-56));for(var t=63;t>=56;--t)this._buf[t]=255&n,n>>>=8;this._compress(this._buf);for(var r=0,t=0;8>t;++t)for(var o=24;o>=0;o-=8)e[r++]=this._chain[t]>>o&255;return e},TT2.prototype.detect_type_name=function(t){var e=this,n=t;4==this.tag_id[0]&&this.device.read_block(16,function(t){e.type_name=t?"Mifare Ultralight":"Mifare Ultralight C",console.debug("[DEBUG] TT2.type_name = "+e.type_name),n&&n()})},TT2.prototype.read=function(t,e){function n(e,n){function o(t){var e=(240&t)>>4;return 1==e?!0:!1}function i(t){return 0==(240&t)?!0:!1}function a(e,n,o){if(console.log("[DEBUG] poll_n: "+o),--o<0){DevManager.defaultCallback("[DEBUG] got a type 2 tag:",e.buffer);for(var i=16;i<e.length;)switch(e[i]){case 0:console.debug("NULL TLV"),i++;break;case 1:console.debug("Found Lock Control TLV");var s=e[i+2]>>4,c=15&e[i+2],u=e[i+3];0==u&&(u=256);var l=Math.pow(2,15&e[i+4]),f=e[i+4]>>4;console.debug("Lock control: BytesLockedPerLockBit="+f+", Size="+u);var h=s*l+c;console.info("Lock control: ByteAddr="+h),console.info("  Locked bytes:");for(var p=64,d=0;(u+7)/8>d;d++){var g=h+d;if(g>=e.length){console.warn("  card["+g+"] haven't read out yet.");break}var y=e[g];console.debug("  ["+g+"]: "+y.toString(16)),1&y&&console.debug("* block-locking");for(var v=1;8>v;v++)if(!(8*d+v>=u)){for(var _="",w=0;f>w;p++)_+="0x"+p.toString(16)+", ";y&1<<v&&console.info("    "+_)}}i+=2+e[i+1];break;case 254:return void console.debug("Terminator TLV.");case 3:var m=e[i+1];return i+2+m>e.length&&console.warn("TLV len "+m+" > card len "+e.length),r(0,new Uint8Array(e.subarray(i+2,i+2+m)).buffer);default:return void console.error("Unknown Type ["+e[i]+"]")}}t.read_block(n,function(t,i){return t?r(t):(e=NFC.util.concat(e,new Uint8Array(i)),a(e,n+4,o))})}if(e)return r(e);var s=new Uint8Array(n),c=new Uint8Array(n),u=8*c[14],l=c[12],f=c[13],h=c[15];if(225!=l||!o(f)||!i(h))return console.log("UNsupported type 2 tag: CC0="+l+", CC1="+f+", CC3="+h),r(1911,c.buffer);var p=Math.floor((u+15)/16),d=4;a(s,d,p)}e||(e=DevManager.defaultCallback);var r=e;t.read_block(0,n)},TT2.prototype.compose=function(t){var e,n=0;t.length+16+2+1>64?(e=18,n=1):e=6;var r=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,225,16,e,0]),o=new Uint8Array(n?[1,3,160,16,68]:[]),i=new Uint8Array([3,t.length]),a=new Uint8Array([254]),s=NFC.util.concat(r,NFC.util.concat(o,NFC.util.concat(i,NFC.util.concat(new Uint8Array(t),a))));return s},TT2.prototype.write=function(t,e,n){function r(e,n){if(n>=s)return i(0);var o=e.subarray(4*n,4*n+4);o.length<4&&(o=NFC.util.concat(o,new Uint8Array(4-o.length))),t.write_block(n,o,function(t){return t?i(t):void r(e,n+1)})}n||(n=DevManager.defaultCallback);var o=this,i=n,a=o.compose(new Uint8Array(e)),s=Math.floor((a.length+3)/4);return s>16&&(console.warn("write_tt2() card length: "+a.length+" is larger than 64 bytes. Try to write as Ultralight-C."),s>48)?(console.error("write_tt2() card length: "+a.length+" is larger than 192 bytes (more than Ultralight-C can provide)."),i(3003)):void r(a,3)},TT2.prototype.emulate=function(t,e,n,r){var o=this.compose(new Uint8Array(e.compose()));return t.emulate_tag(o,n,r)},llSCL3711.prototype.notifyClientOfClosure=function(t){var e=t.onclose;e&&window.setTimeout(e,0)},llSCL3711.prototype.close=function(){for(;0!=this.clients.length;)this.notifyClientOfClosure(this.clients.shift());devManager.dropDevice(this)},llSCL3711.prototype.publishFrame=function(t){for(var e=this.clients,n=[],r=!1,o=0;o<e.length;++o){var i=e[o];i.receivedFrame(t)?n.push(i):(r=!0,console.log(NFC.util.fmt("["+i.cid.toString(16)+"] left?")))}r&&(this.clients=n)},llSCL3711.prototype.readLoop=function(){if(this.dev){var t=this;chrome.usb.bulkTransfer(this.dev,{direction:"in",endpoint:this.endpoint,length:2048},function(e){if(!e.data)throw console.log("no x.data!"),console.log(e),"no x.data!";if(e.data.byteLength>=5){var n=new Uint8Array(e.data);console.log(NFC.util.fmt("<"+NFC.util.BytesToHex(n))),t.publishFrame(e.data),window.setTimeout(function(){t.readLoop()},0)}else console.error(NFC.util.fmt("tiny reply!")),console.error(e)
})}},llSCL3711.prototype.registerClient=function(t){this.clients.push(t)},llSCL3711.prototype.deregisterClient=function(t){var e=this.clients;this.clients=[];for(var n=0;n<e.length;++n){var r=e[n];r!=t&&this.clients.push(r)}return this.clients.length},llSCL3711.prototype.writePump=function(){function t(){n.txqueue.shift(),0!=n.txqueue.length&&window.setTimeout(function(){n.writePump()},0)}if(this.dev&&0!=this.txqueue.length){var e=this.txqueue[0],n=this,r=new Uint8Array(e);console.log(NFC.util.fmt(">"+NFC.util.BytesToHex(r))),chrome.usb.bulkTransfer(this.dev,{direction:"out",endpoint:this.endpoint,data:e},t)}},llSCL3711.prototype.writeFrame=function(t){if(!this.dev)return!1;var e=0==this.txqueue.length;return this.txqueue.push(t),e&&this.writePump(),!0},NFC.util={StringToBytes:function(t,e){e=e||new Array(t.length);for(var n=0;n<t.length;++n)e[n]=t.charCodeAt(n);return e},BytesToString:function(t){for(var e=new String,n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e},BytesToHex:function(t){if(!t)return"(null)";for(var e="0123456789ABCDEF",n=new Array(2*t.length),r=0;r<t.length;++r)n[2*r+0]=e.charAt(t[r]>>4&15),n[2*r+1]=e.charAt(15&t[r]);return n.join("")},BytesToHexWithSeparator:function(t,e){for(var n="0123456789ABCDEF",r=2+(e?1:0),o=new Array(t.length*r),i=0;i<t.length;++i)e&&(o[i*r+0]=e),o[i*r+r-2]=n.charAt(t[i]>>4&15),o[i*r+r-1]=n.charAt(15&t[i]);return(e?o.slice(1):o).join("")},HexToBytes:function(t){for(var e="0123456789ABCDEFabcdef",n=new Uint8Array(t.length/2),r=0;r<t.length&&-1!=e.indexOf(t.substring(r,r+1));r+=2)n[r/2]=parseInt(t.substring(r,r+2),16);return n},equalArrays:function(t,e){if(!t||!e)return!1;if(t.length!=e.length)return!1;for(var n=0,r=0;r<t.length;++r)n|=t[r]^e[r];return 0===n},ltArrays:function(t,e){if(t.length<e.length)return!0;if(t.length>e.length)return!1;for(var n=0;n<t.length;++n){if(t[n]<e[n])return!0;if(t[n]>e[n])return!1}return!1},geArrays:function(t,e){return!NFC.util.ltArrays(t,e)},getRandom:function(t){var e=new Array(t),n=new Uint8Array(t);window.crypto.getRandomValues(n);for(var r=0;t>r;++r)e[r]=255&n[r];return e},equalArrays:function(t,e){if(!t||!e)return!1;if(t.length!=e.length)return!1;for(var n=0,r=0;r<t.length;++r)n|=t[r]^e[r];return 0===n},setFavicon:function(t){var e=document.createElement("link");e.rel="Shortcut Icon",e.type="image/x-icon",e.href=t;for(var n=document.getElementsByTagName("head")[0],r=n.getElementsByTagName("link"),o=0;o<r.length;o++){var i=r[o];i.type==e.type&&i.rel==e.rel&&n.removeChild(i)}n.appendChild(e)},clear:function(t){if(t instanceof Array)for(var e=0;e<t.length;++e)t[e]=0},time:function(){var t=new Date,e="000"+t.getMilliseconds(),n=t.toTimeString().substring(0,8)+"."+e.substring(e.length-3);return n},fmt:function(t){return NFC.util.time()+" "+t},concat:function(t,e){var n,r=new Uint8Array(t.length+e.length),o=0;for(n=0;n<t.length;n++,o++)r[o]=t[n];for(n=0;n<e.length;n++,o++)r[o]=e[n];return r}};