/*
 * Copyright 2014 Google Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at

 *     http://www.apache.org/licenses/LICENSE-2.0
  
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function DevManager(){this.devs=[],this.enumerators=[]}function MifareClassic(t){this.tag_id=new Uint8Array(t),this.type_name="MIFARE Classic 1K",this.WRITE_COMMAND=160}function NDEF(t,e){this.ndef=[],this.prepending=["","http://www.","https://www.","http://","https://","tel:","mailto:","ftp://anonymous:anonymous@","ftp://ftp.","ftps://","sftp://","smb://","nfs://","ftp://","dav://","news:","telnet://","imap:","rtsp://","urn:","pop:","sip:","sips:","tftp:","btspp://","btl2cpa://","btgoep://","tcpobex://","irdaobex://","file://","urn:epc:id:","urn:epc:tag:","urn:epc:pat:","urn:epc:raw:","urn:epc:","urn:nfc:"],t&&(this.ndef=this.parse(t,e))}function NFC(){function t(t){for(var e=new NDEF,n=0;n<t.length;n++)e.add(t[n]);return e}function e(t,e,n){void 0==n&&(n=9999999999),t.wait_for_passive_target(n,function(t,n,r){return t?(NFC.util.log("NFC.wait_for_passive_target() = "+t),e(t),t):(NFC.util.log("[DEBUG] nfc.wait_for_passive_target: "+n+" with ID: "+NFC.util.BytesToHex(new Uint8Array(r))),void e(t,n,r))})}this.findDevices=function(t){var e=new usbSCL3711;window.setTimeout(function(){e.open(0,function(n){return n?(NFC.util.log("NFC.device.open() = "+n),t([]),n):(e.vendorId=e.dev.dev.vendorId,e.productId=e.dev.dev.productId,void t([e]))},function(){console.debug("device.onclose() is called.")})},1e3)},this.read=function(t,n,r){var i=n.timeout,o=r;e(t,function(e,n,r){var i=new Tag(n,r);return i?void i.read(t,function(t,e){if(t)return NFC.util.log("NFC.read.read() = "+t),o(null,null),t;var r=new NDEF(e);o(n+".ndef",r)}):void NFC.util.log("nfc.read: unknown tag_type: "+n)},i)},this.read_logic=function(t,n,r,i){var o=i;e(t,function(e,i,a){var u=new Tag(i,a);return u?u.read_logic?void u.read_logic(t,n,r,function(t){o(0,t)}):void NFC.util.log("nfc.read: "+i+" doesn't support reading logic block"):void NFC.util.log("nfc.read_logic: unknown tag_type: "+i)})},this.wait_for_tag=function(t,n,r){var i=r,o=function(n){e(t,function(t,e,r){t>=0?i(e,r):n>0?window.setTimeout(function(){o(n-250)},250):i(null,null)})};o(n)},this.write=function(n,r,i,o){e(n,function(e,o,a){var u=new Tag(o,a);if(!u)return void NFC.util.log("nfc.write: unknown tag_type: "+o);var l=t(r.ndef);u.write(n,l.compose(),function(t){i(t)})},o)},this.write_logic=function(t,n,r,i){var o=i;e(t,function(e,i,a){var u=new Tag(i,a);return u?u.write_logic?void u.write_logic(t,n,r,function(t){o(t)}):void NFC.util.log("nfc.read: "+i+" doesn't support reading logic block"):void NFC.util.log("nfc.write_logic: unknown tag_type: "+i)})},this.write_physical=function(t,n,r,i,o){var a=o;e(t,function(e,o,u){var l=new Tag(o,u);return l?l.write_physical?void l.write_physical(t,n,r,i,function(t){a(t)}):void NFC.util.log("nfc.read: "+o+" doesn't support reading physical block"):void NFC.util.log("nfc.write_physical: unknown tag_type: "+o)})},this.emulate_tag=function(n,r,i,o){void 0==o&&(o=9999999999),e(n,function(){var e=new TT2,a=t(r.ndef);e.emulate(n,a,o,function(t){i(t)})},o)}}function usbSCL3711(){this.dev=null,this.cid=16777215&++scl3711_id,this.rxframes=[],this.rxcb=null,this.onclose=null,this.detected_tag=null,this.auth_key=null,this.authed_sector=null,this.KEYS=[new Uint8Array([255,255,255,255,255,255]),new Uint8Array([211,247,211,247,211,247]),new Uint8Array([160,161,162,163,164,165])],this.strerror=function(t){var e={1:"time out, the target has not answered",2:"checksum error during rf communication",3:"parity error during rf communication",4:"erroneous bit count in anticollision",5:"framing error during mifare operation",6:"abnormal bit collision in 106 kbps anticollision",7:"insufficient communication buffer size",9:"rf buffer overflow detected by ciu",10:"rf field not activated in time by active mode peer",11:"protocol error during rf communication",13:"overheated - antenna drivers deactivated",14:"internal buffer overflow",16:"invalid command parameter",18:"unsupported command from initiator",19:"format error during rf communication",20:"mifare authentication error",24:"not support NFC secure",25:"i2c bus line is busy",35:"wrong uid check byte (14443-3)",37:"command invalid in current dep state",38:"operation not allowed in this configuration",39:"not acceptable command due to context",41:"released by initiator while operating as target",42:"card ID does not match",43:"the card previously activated has disapperaed",44:"Mismatch between NFCID3 initiator and target in DEP 212/424 kbps",45:"Over-current event has been detected",46:"NAD missing in DEP frame",47:"deselected by initiator while operating as target",49:"initiator rf-off state detected in passive mode",127:"pn53x application level error"};return t in e?"["+t+"] "+e[t]:"Unknown error: "+t}}function SHA256(){this._buf=new Array(64),this._W=new Array(64),this._pad=new Array(64),this._k=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],this._pad[0]=128;for(var t=1;64>t;++t)this._pad[t]=0;this.reset()}function Tag(t,e){switch(t){case"tt2":return new TT2(e);case"mifare_classic":return new MifareClassic(e)}return null}function TT2(t){this.tag_id=new Uint8Array(t),this.type_name=null,this.lock_contorl=[]}function llSCL3711(t,e){this.dev=t,this.txqueue=[],this.clients=[],this.acr122=e,this.endpoint=e?2:4,this.readLoop()}var base64=function(){this.inmap=[0,0,0,0,0,0,0,0,0,0,0,0,0,63,0,0,53,54,55,56,57,58,59,60,61,62,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,0,0,0,0,64,0,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,0,0,0,0,0],this.encode=function(t,e,n){e="undefined"==typeof e?t.length:e,n="undefined"==typeof n?!0:n;for(var r=n?"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i="",o=0,a=0,u=0;e--;)for(a<<=8,a|=t[u++],o+=8;o>=6;){var l=a>>o-6&63;i+=r.charAt(l),o-=6}if(o){a<<=8,o+=8;var l=a>>o-6&63;i+=r.charAt(l)}if(!n)for(;i.length%4;)i+="=";return i},this.decode=function(t){for(var e=[],n=0,r=0,i=0;i<t.length;++i){var o=t.charCodeAt(i);if(32>o||o>127||!this.inmap[o-32])return[];n<<=6,n|=this.inmap[o-32]-1,r+=6,r>=8&&(e.push(n>>r-8&255),r-=8)}return e}}();DevManager.prototype.dropDevice=function(t){var e=this.devs;this.devs=[];for(var n=!1,r=0;r<e.length;++r)e[r]!==t?this.devs.push(e[r]):n=!0;n&&(t.dev&&(chrome.usb.releaseInterface(t.dev,0,function(){NFC.util.log(NFC.util.fmt("released"))}),chrome.usb.closeDevice(t.dev,function(){NFC.util.log(NFC.util.fmt("closed"))}),t.dev=null),NFC.util.log(this.devs.length+" devices remaining"))},DevManager.prototype.closeAll=function(t){console.debug("DevManager.closeAll() is called");for(var e=this.devs.slice(0),n=0;n<e.length;++n)e[n].close();t&&t()},DevManager.prototype.enumerate=function(t){function e(t,e){var r=0;if(t&&0!=t.length)NFC.util.log(NFC.util.fmt("Enumerated "+t.length+" devices")),NFC.util.log(t),r=t.length;else{if(!t){NFC.util.log("Lacking permission?");do!function(t){t&&window.setTimeout(function(){t(-666)},0)}(n.enumerators.shift());while(n.enumerators.length);return}NFC.util.log("No devices found")}for(var i=0;r>i;++i)!function(t,i){window.setTimeout(function(){chrome.usb.claimInterface(t,0,function(){if(NFC.util.log(NFC.util.fmt("claimed")),NFC.util.log(t),n.devs.push(new llSCL3711(t,e)),i==r-1){var o=new Uint8Array(4);for(o[0]=r>>24,o[1]=r>>16,o[2]=r>>8,o[3]=r;n.enumerators.length;)!function(t){window.setTimeout(function(){t&&t(0,o)},20)}(n.enumerators.shift())}})},0)}(t[i],i)}var n=this;if(0!=this.devs.length){var r=new Uint8Array(4);r[0]=this.devs.length>>24,r[1]=this.devs.length>>16,r[2]=this.devs.length>>8,r[3]=this.devs.length,t&&t(0,r)}else{var i=0==this.enumerators.length;this.enumerators.push(t),i&&window.setTimeout(function(){chrome.usb.findDevices({vendorId:1254,productId:21905},function(t){t&&0!=t.length?e(t,!1):chrome.usb.findDevices({vendorId:1839,productId:8704},function(t){t&&0!=t.length&&e(t,!0)})})},0)}},DevManager.prototype.open=function(t,e,n){var r=this;this.enumerate(function(){var i=r.devs[t];i&&i.registerClient(e),n&&n(i||null)})},DevManager.prototype.close=function(t,e){for(var n=this.devs,r=0;r<n.length;++r){var i=n[r];i.deregisterClient(e)}},DevManager.DevManager.defaultCallback=function(t,e){var n="DevManager.defaultCallback("+t;e&&(n+=", "+NFC.util.BytesToHex(new Uint8Array(e))),n+=")",NFC.util.log(NFC.util.fmt(n))};var devManager=new DevManager;MifareClassic.prototype.log2sec=function(t){return 2>t?0:Math.floor((t-2)/3)+1},MifareClassic.prototype.log2phy=function(t){if(2>t)return t+1;var e=this.log2sec(t);return 4*e+(t-2)%3},MifareClassic.prototype.mif_calc_crc8=function(t){for(var e=199,n=0;n<t.length;n++){e^=t[n];for(var r=0;8>r;r++)128&e?e=e<<1^29:e<<=1}return e},MifareClassic.prototype.mif_calc_crc16=function(t){for(var e=51084,n=0;n<t.length;n++){e^=t[n]<<8;for(var r=0;8>r;r++)32768&e?e=e<<1^4129:e<<=1}return e},MifareClassic.prototype.copy_auth_keys=function(t,e){for(var n=0;6>n;n++)t[n]=e.auth_key[n];for(var n=0;6>n;n++)t[n+10]=255;return t},MifareClassic.prototype.read_physical=function(t,e,n,r){function i(t,e,n){if(3==t&&105!=e[57]){var r;for(r=0;3==e[18+2*r+0]&&225==e[18+2*r+1];r++);var i=4*(r+1);return n>i?i:n}return n}function o(t){var e=t;l.publicAuthentication(e,function(t){return t?u(t):void l.read_block(e,function(t,n){if(t)return u(t);var n=new Uint8Array(n);return e%4==3&&(n=a.copy_auth_keys(n,l)),s=NFC.util.concat(s,n),c=i(e,s,c),e+1>=c?u(s):o(e+1,r)})})}var a=this,u=r,l=t,s=new Uint8Array,c=64;null!=n&&(c=e+n),o(e)},MifareClassic.prototype.read=function(t,e){var n=this;e||(e=DevManager.defaultCallback);{var r=e;new Uint8Array}n.read_physical(t,0,null,function(t){for(var e=0;e<Math.ceil(t.length/16);e++)NFC.util.log(NFC.util.fmt("[DEBUG] Sector["+NFC.util.BytesToHex([e])+"] "+NFC.util.BytesToHex(t.subarray(16*e,16*e+16))));var n=t[57];if(105==n)NFC.util.log("[DEBUG] Sector 0 is non-personalized (0x69).");else{var i;for(i=0;3==t[18+2*i+0]&&225==t[18+2*i+1];i++);for(var o=new Uint8Array,e=1;i>=e;e++)o=NFC.util.concat(o,t.subarray(64*e,64*e+48));for(var e=0;e<o.length;e++)switch(o[e]){case 0:NFC.util.log("[DEBUG] NULL TLV.");break;case 254:return void NFC.util.log("[DEBUG] Terminator TLV.");case 3:var a=o[e+1];return a+2>o.length&&NFC.util.log("[WARN] Vlen:"+a+" > totla len:"+o.length),r(0,new Uint8Array(o.subarray(e+2,e+2+a)).buffer);default:return void NFC.util.log("[ERROR] Unsupported TLV: "+NFC.util.BytesToHex(o[0]))}}})},MifareClassic.prototype.read_logic=function(t,e,n,r){function i(e,n){var r=e,l=n;return 0>=l?a(u):void o.read_physical(t,o.log2phy(e),1,function(t){u=NFC.util.concat(u,t),i(r+1,l-1)})}var o=this,a=r,u=new Uint8Array;i(e,n)},MifareClassic.prototype.compose=function(t){for(var e=this,n=new Uint8Array([3,t.length]),r=new Uint8Array([254]),i=NFC.util.concat(n,NFC.util.concat(new Uint8Array(t),r)),o=Math.ceil(i.length/48),a=new Uint8Array,u=0;o>u;u++){a=NFC.util.concat(a,i.subarray(48*u,48*(u+1)));var l;l=new Uint8Array(u+1==o?48-i.length%48:0),a=NFC.util.concat(a,l),a=NFC.util.concat(a,new Uint8Array([211,247,211,247,211,247,127,7,136,64,255,255,255,255,255,255]))}for(var s=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,225,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,160,161,162,163,164,165,120,119,136,193,255,255,255,255,255,255]),u=0;o>u;u++)s[16+2*(u+1)+0]=3,s[16+2*(u+1)+1]=225;s[16]=e.mif_calc_crc8(s.subarray(17,48));var c=NFC.util.concat(s,a);return c},MifareClassic.prototype.write_physical=function(t,e,n,r,i){function o(t){if(t)return s(t);var e=l.subarray(0,16);a.write_block(u,e,function(t){return t?s(t):void c.write_physical(a,u+1,n,l.subarray(16),s)},c.WRITE_COMMAND)}var a=t,u=e,l=r,s=i,c=this;return 0==l.length?s(0):(l.length<16&&(l=NFC.util.concat(l,new Uint8Array(16-l.length))),void(null==n?a.publicAuthentication(u,o):a.privateAuthentication(u,n,o)))},MifareClassic.prototype.write=function(t,e,n){var r=this;n||(n=DevManager.defaultCallback);var i=n,o=r.compose(new Uint8Array(e)),a=t,u=Math.ceil(o.length/16);return u>64?(NFC.util.log("write Classic() card is too big (max: 1024 bytes): "+o.length),i(3003)):void r.write_physical(a,1,null,o.subarray(16),i)},MifareClassic.prototype.write_logic=function(t,e,n,r){function i(t,e,n){var r=t,u=e,l=n;return 0==l.length?a(0):void o.write_physical(r,o.log2phy(u),null,l.subarray(0,16),function(t){if(t)return a(t);var e=4*o.log2sec(u)+3;r.read_block(e,function(t,n){if(t)return a(t);var n=new Uint8Array(n);n=o.copy_auth_keys(n,r),n[9]=3==e?193:64,r.write_block(e,n,function(){return u+=1,l=l.subarray(16),i(r,u,l)},o.WRITE_COMMAND)})})}var o=this,a=r;i(t,e,n)},MifareClassic.prototype.emulate=function(t,e,n,r){var i=this.compose(new Uint8Array(e.compose()));return t.emulate_tag(i,n,r)},NDEF.prototype.parse=function(t,e){var n,r=[];for(t=new Uint8Array(t),n=0;n<t.length;n++){var i,o,a,u,l,s=(128&t[n])>>7,c=(64&t[n])>>6,f=((32&t[n])>>5,(16&t[n])>>4),h=(8&t[n])>>3,p=(7&t[n])>>0,d=t[n+1],g=4+d;if(f?(i=3,g=3+d,u=t[n+2]):(i=6,g=6+d,u=256*(256*(256*t[n+2]+t[n+3])+t[n+4])+t[n+5]),h){i+=1;var y=t[n+i-1];g+=1+y;var v=i+d;o=t.subarray(n+v,n+v+y)}else o=null;switch(a=new Uint8Array(t.subarray(n+i,n+i+d)),l=new Uint8Array(t.subarray(n+g,n+g+u)),NFC.util.log("raw[i]: "+t[n]),NFC.util.log("MB: "+s),NFC.util.log("ME: "+c),NFC.util.log("SR: "+f),NFC.util.log("IL: "+h),NFC.util.log("TNF: "+p),NFC.util.log("type_off: "+i),NFC.util.log("type_len: "+d),NFC.util.log("payload_off: "+g),NFC.util.log("payload_len: "+u),NFC.util.log("type: "+NFC.util.BytesToHex(a)),NFC.util.log("payload: "+NFC.util.BytesToHex(l)),p){case 1:r.push(this.parse_RTD(a[0],l));break;case 2:r.push(this.parse_MIME(a,l));break;case 4:r.push(this.parse_ExternalType(a,l));break;default:console.error("Unsupported TNF: "+p)}if(n=g+u-1,c)break}return e&&e(r),r},NDEF.prototype.compose=function(){for(var t=new Uint8Array,e=[],n=0;n<this.ndef.length;n++){var r=this.ndef[n];switch(r.type){case"TEXT":case"Text":e.push({TNF:1,TYPE:new Uint8Array([84]),PAYLOAD:this.compose_RTD_TEXT(r.lang,r.text)});break;case"URI":e.push({TNF:1,TYPE:new Uint8Array([85]),PAYLOAD:this.compose_RTD_URI(r.uri)});break;case"MIME":e.push({TNF:2,TYPE:new Uint8Array(NFC.util.StringToBytes(r.mime_type)),PAYLOAD:this.compose_MIME(r.payload)});break;case"AAR":e.push({TNF:4,TYPE:new Uint8Array(NFC.util.StringToBytes("android.com:pkg")),PAYLOAD:this.compose_AAR(r.aar)});break;default:console.error("Unsupported RTD type:"+r.type)}}for(var n=0;n<e.length;n++){var i=16|e[n].TNF;i|=0==n?128:0,i|=n==e.length-1?64:0;var o=e[n].TYPE,a=e[n].PAYLOAD;t=NFC.util.concat(t,[i,o.length,a.length]),t=NFC.util.concat(t,o),t=NFC.util.concat(t,a)}return t.buffer},NDEF.prototype.add=function(t){switch("uri"in t?t.type="URI":"text"in t?t.type="TEXT":"aar"in t?t.type="AAR":"payload"in t&&(t.type="MIME"),t.type){case"TEXT":case"Text":if("encoding"in t||(t.encoding="utf8"),"lang"in t||(t.lang="en"),"text"in t)return this.ndef.push(t),!0;break;case"URI":if("uri"in t)return this.ndef.push(t),!0;break;case"MIME":if("mime_type"in t&&"payload"in t)return this.ndef.push(t),!0;case"AAR":if("aar"in t)return this.ndef.push(t),!0;break;default:NFC.util.log("Unsupported RTD type:"+t.type)}return!1},NDEF.prototype.parse_RTD=function(t,e){switch(t){case 84:return this.parse_RTD_TEXT(e);case 85:return this.parse_RTD_URI(e);default:NFC.util.log("Unsupported RTD type: "+t)}},NDEF.prototype.parse_MIME=function(t,e){return{type:"MIME",mime_type:NFC.util.BytesToString(t),payload:NFC.util.BytesToString(e)}},NDEF.prototype.compose_MIME=function(t){return new Uint8Array(NFC.util.StringToBytes(t))},NDEF.prototype.parse_AAR=function(t){return{type:"AAR",payload:NFC.util.BytesToString(t)}},NDEF.prototype.parse_ExternalType=function(t,e){return"android.com:pkg"==NFC.util.BytesToString(t)?this.parse_AAR(e):{type:t,payload:NFC.util.BytesToString(e)}},NDEF.prototype.compose_AAR=function(t){return new Uint8Array(NFC.util.StringToBytes(t))},NDEF.prototype.parse_RTD_TEXT=function(t){var e=(128&t[0])>>7,n=63&t[0],r=t.subarray(1,1+n),i=t.subarray(1+n,t.length);return{type:"Text",encoding:e?"utf16":"utf8",lang:NFC.util.BytesToString(r),text:NFC.util.BytesToString(i)}},NDEF.prototype.compose_RTD_TEXT=function(t,e){var n=t.length;return n=n>63?63:n,new Uint8Array([n].concat(NFC.util.StringToBytes(t.substring(0,n))).concat(NFC.util.StringToBytes(e)))},NDEF.prototype.parse_RTD_URI=function(t){return{type:"URI",uri:this.prepending[t[0]]+NFC.util.BytesToString(t.subarray(1,t.length))}},NDEF.prototype.compose_RTD_URI=function(t){for(var e,n=-1,r=0;r<this.prepending.length;r++)t.substring(0,this.prepending[r].length)==this.prepending[r]&&this.prepending[r].length>n&&(e=r,n=this.prepending[r].length);return new Uint8Array([e].concat(NFC.util.StringToBytes(t.substring(n))))},chrome.nfc=NFC();var scl3711_id=0;usbSCL3711.prototype.notifyFrame=function(t){0!=this.rxframes.length?t&&window.setTimeout(t,0):this.rxcb=t},usbSCL3711.prototype.receivedFrame=function(t){if(!this.rxframes)return!1;this.rxframes.push(t);var e=this.rxcb;return this.rxcb=null,e&&window.setTimeout(e,0),!0},usbSCL3711.prototype.readFrame=function(){if(0==this.rxframes.length)throw"rxframes empty!";var t=this.rxframes.shift();return t},usbSCL3711.prototype.read=function(t,e){function n(t,e,n){o&&(window.clearTimeout(o),o=null);var r=a;r&&(a=null,window.setTimeout(function(){r(t,e,n)},0))}function r(){a&&o&&(NFC.util.log(NFC.util.fmt("["+u.cid.toString(16)+"] timeout!")),o=null)}function i(){if(a&&o){var t=new Uint8Array(u.readFrame());if(6==t.length&&0==t[0]&&0==t[1]&&255==t[2]&&0==t[3]&&255==t[4]&&0==t[5])return void u.notifyFrame(i);if(t.length>10&&(128==t[0]?t=NFC.util.concat(new Uint8Array([0,0,255,1,255]),new Uint8Array(t.subarray(10))):131==t[0]&&(t=NFC.util.concat(new Uint8Array([0,0,255,1,255]),new Uint8Array(t.subarray(10))))),7==t.length){if(144==t[5]&&0==t[6])return void n(0,t.buffer);if(99==t[5]&&0==t[6])return void n(2730,t.buffer)}else if(t.length>6&&0==t[0]&&0==t[1]&&255==t[2]&&t[3]+t[4]==256){if(213==t[5]&&65==t[6])return void(0==t[7]?n(0,new Uint8Array(t.subarray(8,t.length-2)).buffer):NFC.util.log("ERROR: InDataExchange reply status = "+u.strerror(t[7])));if(213==t[5]&&141==t[6])return void n(0,new Uint8Array(t.subarray(8,t.length-2)).buffer);if(213==t[5]&&137==t[6])return void(0==t[7]?n(0,new Uint8Array(t.subarray(8,t.length-2)).buffer):NFC.util.log("ERROR: TgGetInitiatorCommand reply status = "+u.strerror(t[7])));if(213==t[5]&&145==t[6])return void(0==t[7]?n(0,new Uint8Array(t.subarray(8,t.length-2)).buffer):NFC.util.log("ERROR: TgResponseToInitiator reply status = "+u.strerror(t[7])));if(213==t[5]&&51==t[6])return void n(0,new Uint8Array(t.subarray(7,t.length-2)).buffer);if(213==t[5]&&75==t[6]){if(1!=t[7]||1!=t[8])return void NFC.util.log("DEBUG: found "+t[7]+" target, tg="+t[8]);NFC.util.log("DEBUG: InListPassiveTarget SENS_REQ(ATQA)=0x"+(256*t[9]+t[10]).toString(16)+", SEL_RES(SAK)=0x"+t[11].toString(16));var e=t[12],r=new Uint8Array(t.subarray(13,13+e)).buffer;if(NFC.util.log("DEBUG: tag_id: "+NFC.util.BytesToHex(new Uint8Array(r))),0==t[9]&&68==t[10])return NFC.util.log("DEBUG: found Mifare Ultralight (106k type A)"),u.detected_tag="Mifare Ultralight",u.authed_sector=null,u.auth_key=null,void n(0,"tt2",r);if(0==t[9]&&4==t[10])return NFC.util.log("DEBUG: found Mifare Classic 1K (106k type A)"),u.detected_tag="Mifare Classic 1K",u.authed_sector=null,u.auth_key=null,void n(0,"mifare_classic",r)}}n(2184,t.buffer)}}if(!this.dev)return void e(1);var o=null,a=e,u=this;o=window.setTimeout(r,1e3*t),u.notifyFrame(i)},usbSCL3711.prototype.write=function(t){this.dev.writeFrame(t)},usbSCL3711.prototype.exchange=function(t,e,n){this.write(t),this.read(e,n)},usbSCL3711.prototype.acr122_reset_to_good_state=function(t){var e=this,n=t;e.exchange(new Uint8Array([0,0,255,0,255,0]).buffer,1,function(t){t&&console.warn("[FIXME] acr122_reset_to_good_state: rc = "+t),e.exchange(new Uint8Array([98,0,0,0,0,0,0,1,0,0]).buffer,10,function(t){t&&console.warn("[FIXME] icc_power_on: rc = "+t),NFC.util.log("[DEBUG] icc_power_on: turn on the device power"),n&&window.setTimeout(function(){n(0)},100)})})},usbSCL3711.prototype.acr122_set_buzzer=function(t,e){var n=this,r=e,i=t?255:0;n.exchange(new Uint8Array([107,5,0,0,0,0,0,0,0,0,255,0,82,i,0]).buffer,1,function(t,e){r&&r(t,e)})},usbSCL3711.prototype.acr122_load_authentication_keys=function(t,e,n){var r=this,i=n;null==t?t=r.KEYS[0]:"object"!=typeof t&&(t=r.KEYS[t]);var o=new Uint8Array([107,11,0,0,0,0,0,0,0,0,255,130,0,e,6]);o=NFC.util.concat(o,t),r.exchange(o.buffer,1,function(n,r){NFC.util.log("[DEBUG] acr122_load_authentication_keys(loc: "+e+", key: "+NFC.util.BytesToHex(t)+") = "+n),i&&i(n,r)})},usbSCL3711.prototype.acr122_authentication=function(t,e,n,r){var i=this,o=r;i.exchange(new Uint8Array([107,10,0,0,0,0,0,0,0,0,255,134,0,0,5,1,0,t,n,e]).buffer,1,function(r,i){NFC.util.log("[DEBUG] acr122_authentication(loc: "+e+", type: "+n+", block: "+t+") = "+r),o&&o(r,i)})},usbSCL3711.prototype.publicAuthentication=function(t,e){function n(e){var a=e;return a>=3?void(i&&i(4095)):void r.acr122_load_authentication_keys(a,0,function(e){e||r.acr122_authentication(t,0,96,function(e){return e?n(a+1):(r.authed_sector=o,r.auth_key=r.KEYS[a],void r.acr122_load_authentication_keys(r.KEYS[0],1,function(){r.acr122_authentication(t,1,97,function(t,e){i&&i(t,e)})}))})})}var r=this,i=e,o=Math.floor(t/4);"Mifare Classic 1K"==r.detected_tag&&r.dev&&r.dev.acr122&&r.authed_sector!=o?(NFC.util.log("[DEBUG] Public Authenticate sector "+o),n(0)):i&&i(0,null)},usbSCL3711.prototype.privateAuthentication=function(t,e,n){var r=this,i=n,o=Math.floor(t/4);"Mifare Classic 1K"==r.detected_tag&&r.dev&&r.dev.acr122&&r.authed_sector!=o?(NFC.util.log("[DEBUG] Private Authenticate sector "+o),r.acr122_load_authentication_keys(e,1,function(){r.acr122_authentication(t,1,97,function(t,e){return t?(NFC.util.log("KEY B AUTH ERROR"),t):void(i&&i(t,e))})})):i&&i(0,null)},usbSCL3711.prototype.acr122_set_timeout=function(t,e){var n=this,r=e,i=Math.ceil(t/5);i>=255&&(i=255),NFC.util.log("[DEBUG] acr122_set_timeout(round up to "+5*i+" secs)"),n.exchange(new Uint8Array([107,5,0,0,0,0,0,0,0,0,255,0,65,i,0]).buffer,1,function(t,e){r&&r(t,e)})},usbSCL3711.prototype.open=function(t,e,n){this.rxframes=[],this.onclose=n,this.cid&=16777215,this.cid|=t+1<<24;var r=this,i=e;devManager.open(t,this,function(t){r.dev=t;var e=null!=r.dev?0:1;r.dev&&r.dev.acr122?r.acr122_reset_to_good_state(function(t){return t?(console.error("[ERROR] acr122_reset_to_good_state() returns "+t),i?i(t):null):void r.acr122_set_buzzer(!1,function(t){return t?(console.error("[ERROR] acr122_reset_to_good_state() returns "+t),i?i(t):null):void(i&&i(e))})}):i&&i(e)})},usbSCL3711.prototype.close=function(){function t(){n.exchange(n.makeFrame(68,new Uint8Array([1])),1,function(){n.exchange(n.makeFrame(82,new Uint8Array([1])),1,function(){})})}function e(){n.rxframes=null,n.dev&&(devManager.close(n.dev,n),n.dev=null)}var n=this;t(e)},usbSCL3711.prototype.makeFrame=function(t,e){var n=new Uint8Array(e?e:[]),r=new Uint8Array(n.length+2),i=n.length+2;if(this.dev.acr122){var o=7+n.length,a=new Uint8Array(10);a[0]=107,a[1]=o>>0&255,a[2]=o>>8&255,a[3]=o>>16&255,a[4]=o>>24&255,a[5]=0,a[6]=0,a[7]=0,a[8]=0,a[9]=0;var u=new Uint8Array(5);u[0]=255,u[1]=0,u[2]=0,u[3]=0,u[4]=n.length+2,l=NFC.util.concat(a,u)}else{var l=new Uint8Array(8);l[0]=0,l[1]=0,l[2]=255,l[3]=255,l[4]=255,l[5]=i>>>8,l[6]=255&i,l[7]=256-(l[5]+l[6]&255)}r[0]=212,r[1]=t;for(var s=r[0]+r[1],c=0;c<n.length;++c)r[2+c]=n[c],s+=n[c];var f=null;return this.dev.acr122?f=new Uint8Array([]):(f=new Uint8Array(2),f[0]=256-(255&s),f[1]=0),NFC.util.concat(NFC.util.concat(l,r),f).buffer},usbSCL3711.prototype.wait_for_passive_target=function(t,e){function n(t,e){r.detected_tag=null,r.exchange(r.makeFrame(74,new Uint8Array([1,0])),t,e)}var r=this;e||(e=DevManager.defaultCallback),r.dev.acr122?r.acr122_set_timeout(t,function(){n(t,e)}):n(t,e)},usbSCL3711.prototype.read_block=function(t,e){var n=this,r=e;e||(e=DevManager.defaultCallback);var i=new Uint8Array(2);i[0]=48,i[1]=t,n.apdu(i,function(t,e){r(t,e)})},usbSCL3711.prototype.emulate_tag=function(t,e,n){function r(){var t=new Uint8Array([1,4,0,0,176,11,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),e=o.makeFrame(140,t);o.exchange(e,a,function(t,e){return 0!=t?void i(t):(NFC.util.log("Emulated as a tag, reply is following:"),void u(new Uint8Array(e)))})}n||(n=DevManager.defaultCallback);var i=n,o=this,a=e,u=function(e){switch(e[0]){case 48:var n=e[1];NFC.util.log("recv TT2.READ(blk_no="+n+")");var r=t.subarray(4*n,4*n+16);r.length<16&&(r=NFC.util.concat(r,new Uint8Array(16-r.length)));var l=o.makeFrame(144,r);o.exchange(l,a,function(t){if(t)return NFC.util.log("exchange(): "+t),t;var e=o.makeFrame(136,[]);o.exchange(e,a,function(t,e){return t?(NFC.util.log("exchange(): "+t),t):void u(new Uint8Array(e))})});break;case 80:NFC.util.log("recv TT2.HALT received."),i(0);break;default:NFC.util.log("Unsupported TT2 tag: "+e[0]),i(2457)}};o.dev.acr122?o.exchange(new Uint8Array([107,5,0,0,0,0,0,0,0,0,255,0,81,0,0]).buffer,1,function(){o.exchange(new Uint8Array([107,9,0,0,0,0,0,0,0,0,255,0,0,0,4,212,50,1,0]).buffer,1,function(t){return 0!=t?void i(t):void o.acr122_set_timeout(e,function(t){return 0!=t?void i(t):void r()})})}):r()},usbSCL3711.prototype.write_block=function(t,e,n,r){var i=n;null==r&&(r=162);var o=new Uint8Array(2+e.length);o[0]=r,o[1]=t;for(var a=0;a<e.length;a++)o[2+a]=e[a];this.apdu(o,function(t){i(t)})},usbSCL3711.prototype.apdu=function(t,e,n){e||(e=DevManager.defaultCallback);for(var r=new Uint8Array(this.makeFrame(64,NFC.util.concat([1],t))),i=0;i<r.length;i+=64)this.dev.writeFrame(new Uint8Array(r.subarray(i,i+64)).buffer);n?e(0,null):this.read(3,function(t,n,r){if(0!=t)return void e(t);var i=new Uint8Array(n);if(r){if(i.length<2)return void e(1638);var o=256*i[i.length-2]+i[i.length-1];e(36864==o?0:o,new Uint8Array(i.subarray(0,i.length-2)).buffer)}else e(0,i.buffer)})},SHA256.prototype.reset=function(){this._chain=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],this._inbuf=0,this._total=0},SHA256.prototype._compress=function(t){function e(t,e){return t<<32-e|t>>>e}for(var n=this._W,r=this._k,i=0;64>i;i+=4){var o=t[i]<<24|t[i+1]<<16|t[i+2]<<8|t[i+3];n[i/4]=o}for(var i=16;64>i;++i){var a=e(n[i-15],7)^e(n[i-15],18)^n[i-15]>>>3,u=e(n[i-2],17)^e(n[i-2],19)^n[i-2]>>>10;n[i]=n[i-16]+a+n[i-7]+u&4294967295}for(var l=this._chain[0],s=this._chain[1],c=this._chain[2],f=this._chain[3],h=this._chain[4],p=this._chain[5],d=this._chain[6],g=this._chain[7],i=0;64>i;++i){var y=e(l,2)^e(l,13)^e(l,22),v=l&s^l&c^s&c,_=y+v&4294967295,C=e(h,6)^e(h,11)^e(h,25),w=h&p^~h&d,b=g+C+w+r[i]+n[i]&4294967295;g=d,d=p,p=h,h=f+b&4294967295,f=c,c=s,s=l,l=b+_&4294967295}this._chain[0]+=l,this._chain[1]+=s,this._chain[2]+=c,this._chain[3]+=f,this._chain[4]+=h,this._chain[5]+=p,this._chain[6]+=d,this._chain[7]+=g},SHA256.prototype.update=function(t,e){e||(e=t.length),this._total+=e;for(var n=0;e>n;++n)this._buf[this._inbuf++]=t[n],64==this._inbuf&&(this._compress(this._buf),this._inbuf=0)},SHA256.prototype.updateRange=function(t,e,n){this._total+=n-e;for(var r=e;n>r;++r)this._buf[this._inbuf++]=t[r],64==this._inbuf&&(this._compress(this._buf),this._inbuf=0)},SHA256.prototype.digest=function(){for(var t=0;t<arguments.length;++t)this.update(arguments[t]);var e=new Array(32),n=8*this._total;this._inbuf<56?this.update(this._pad,56-this._inbuf):this.update(this._pad,64-(this._inbuf-56));for(var t=63;t>=56;--t)this._buf[t]=255&n,n>>>=8;this._compress(this._buf);for(var r=0,t=0;8>t;++t)for(var i=24;i>=0;i-=8)e[r++]=this._chain[t]>>i&255;return e},TT2.prototype.detect_type_name=function(t){var e=this,n=t;4==this.tag_id[0]&&this.device.read_block(16,function(t){e.type_name=t?"Mifare Ultralight":"Mifare Ultralight C",console.debug("[DEBUG] TT2.type_name = "+e.type_name),n&&n()})},TT2.prototype.read=function(t,e){function n(e,n){function i(t){var e=(240&t)>>4;return 1==e?!0:!1}function o(t){return 0==(240&t)?!0:!1}function a(e,n,i){if(NFC.util.log("[DEBUG] poll_n: "+i),--i<0){DevManager.defaultCallback("[DEBUG] got a type 2 tag:",e.buffer);for(var o=16;o<e.length;)switch(e[o]){case 0:console.debug("NULL TLV"),o++;break;case 1:console.debug("Found Lock Control TLV");var u=e[o+2]>>4,l=15&e[o+2],s=e[o+3];0==s&&(s=256);var c=Math.pow(2,15&e[o+4]),f=e[o+4]>>4;console.debug("Lock control: BytesLockedPerLockBit="+f+", Size="+s);var h=u*c+l;console.info("Lock control: ByteAddr="+h),console.info("  Locked bytes:");for(var p=64,d=0;(s+7)/8>d;d++){var g=h+d;if(g>=e.length){console.warn("  card["+g+"] haven't read out yet.");break}var y=e[g];console.debug("  ["+g+"]: "+y.toString(16)),1&y&&console.debug("* block-locking");for(var v=1;8>v;v++)if(!(8*d+v>=s)){for(var _="",C=0;f>C;p++)_+="0x"+p.toString(16)+", ";y&1<<v&&console.info("    "+_)}}o+=2+e[o+1];break;case 254:return void console.debug("Terminator TLV.");case 3:var w=e[o+1];return o+2+w>e.length&&console.warn("TLV len "+w+" > card len "+e.length),r(0,new Uint8Array(e.subarray(o+2,o+2+w)).buffer);default:return void console.error("Unknown Type ["+e[o]+"]")}}t.read_block(n,function(t,o){return t?r(t):(e=NFC.util.concat(e,new Uint8Array(o)),a(e,n+4,i))})}if(e)return r(e);var u=new Uint8Array(n),l=new Uint8Array(n),s=8*l[14],c=l[12],f=l[13],h=l[15];if(225!=c||!i(f)||!o(h))return NFC.util.log("UNsupported type 2 tag: CC0="+c+", CC1="+f+", CC3="+h),r(1911,l.buffer);var p=Math.floor((s+15)/16),d=4;a(u,d,p)}e||(e=DevManager.defaultCallback);var r=e;t.read_block(0,n)},TT2.prototype.compose=function(t){var e,n=0;t.length+16+2+1>64?(e=18,n=1):e=6;var r=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,225,16,e,0]),i=new Uint8Array(n?[1,3,160,16,68]:[]),o=new Uint8Array([3,t.length]),a=new Uint8Array([254]),u=NFC.util.concat(r,NFC.util.concat(i,NFC.util.concat(o,NFC.util.concat(new Uint8Array(t),a))));return u},TT2.prototype.write=function(t,e,n){function r(e,n){if(n>=u)return o(0);var i=e.subarray(4*n,4*n+4);i.length<4&&(i=NFC.util.concat(i,new Uint8Array(4-i.length))),t.write_block(n,i,function(t){return t?o(t):void r(e,n+1)})}n||(n=DevManager.defaultCallback);var i=this,o=n,a=i.compose(new Uint8Array(e)),u=Math.floor((a.length+3)/4);return u>16&&(console.warn("write_tt2() card length: "+a.length+" is larger than 64 bytes. Try to write as Ultralight-C."),u>48)?(console.error("write_tt2() card length: "+a.length+" is larger than 192 bytes (more than Ultralight-C can provide)."),o(3003)):void r(a,3)},TT2.prototype.emulate=function(t,e,n,r){var i=this.compose(new Uint8Array(e.compose()));return t.emulate_tag(i,n,r)},llSCL3711.prototype.notifyClientOfClosure=function(t){var e=t.onclose;e&&window.setTimeout(e,0)},llSCL3711.prototype.close=function(){for(;0!=this.clients.length;)this.notifyClientOfClosure(this.clients.shift());devManager.dropDevice(this)},llSCL3711.prototype.publishFrame=function(t){for(var e=this.clients,n=[],r=!1,i=0;i<e.length;++i){var o=e[i];o.receivedFrame(t)?n.push(o):(r=!0,NFC.util.log(NFC.util.fmt("["+o.cid.toString(16)+"] left?")))}r&&(this.clients=n)},llSCL3711.prototype.readLoop=function(){if(this.dev){var t=this;chrome.usb.bulkTransfer(this.dev,{direction:"in",endpoint:this.endpoint,length:2048},function(e){if(!e.data)throw NFC.util.log("no x.data!"),NFC.util.log(e),"no x.data!";if(e.data.byteLength>=5){var n=new Uint8Array(e.data);NFC.util.log(NFC.util.fmt("<"+NFC.util.BytesToHex(n))),t.publishFrame(e.data),window.setTimeout(function(){t.readLoop()
},0)}else console.error(NFC.util.fmt("tiny reply!")),console.error(e)})}},llSCL3711.prototype.registerClient=function(t){this.clients.push(t)},llSCL3711.prototype.deregisterClient=function(t){var e=this.clients;this.clients=[];for(var n=0;n<e.length;++n){var r=e[n];r!=t&&this.clients.push(r)}return this.clients.length},llSCL3711.prototype.writePump=function(){function t(){n.txqueue.shift(),0!=n.txqueue.length&&window.setTimeout(function(){n.writePump()},0)}if(this.dev&&0!=this.txqueue.length){var e=this.txqueue[0],n=this,r=new Uint8Array(e);NFC.util.log(NFC.util.fmt(">"+NFC.util.BytesToHex(r))),chrome.usb.bulkTransfer(this.dev,{direction:"out",endpoint:this.endpoint,data:e},t)}},llSCL3711.prototype.writeFrame=function(t){if(!this.dev)return!1;var e=0==this.txqueue.length;return this.txqueue.push(t),e&&this.writePump(),!0},NFC.util=function(){var t=!1;this.StringToBytes=function(t,e){e=e||new Array(t.length);for(var n=0;n<t.length;++n)e[n]=t.charCodeAt(n);return e},this.BytesToString=function(t){for(var e=new String,n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e},this.BytesToHex=function(t){if(!t)return"(null)";for(var e="0123456789ABCDEF",n=new Array(2*t.length),r=0;r<t.length;++r)n[2*r+0]=e.charAt(t[r]>>4&15),n[2*r+1]=e.charAt(15&t[r]);return n.join("")},this.BytesToHexWithSeparator=function(t,e){for(var n="0123456789ABCDEF",r=2+(e?1:0),i=new Array(t.length*r),o=0;o<t.length;++o)e&&(i[o*r+0]=e),i[o*r+r-2]=n.charAt(t[o]>>4&15),i[o*r+r-1]=n.charAt(15&t[o]);return(e?i.slice(1):i).join("")},this.HexToBytes=function(t){for(var e="0123456789ABCDEFabcdef",n=new Uint8Array(t.length/2),r=0;r<t.length&&-1!=e.indexOf(t.substring(r,r+1));r+=2)n[r/2]=parseInt(t.substring(r,r+2),16);return n},this.equalArrays=function(t,e){if(!t||!e)return!1;if(t.length!=e.length)return!1;for(var n=0,r=0;r<t.length;++r)n|=t[r]^e[r];return 0===n},this.ltArrays=function(t,e){if(t.length<e.length)return!0;if(t.length>e.length)return!1;for(var n=0;n<t.length;++n){if(t[n]<e[n])return!0;if(t[n]>e[n])return!1}return!1},this.geArrays=function(t,e){return!NFC.util.ltArrays(t,e)},this.getRandom=function(t){var e=new Array(t),n=new Uint8Array(t);window.crypto.getRandomValues(n);for(var r=0;t>r;++r)e[r]=255&n[r];return e},this.equalArrays=function(t,e){if(!t||!e)return!1;if(t.length!=e.length)return!1;for(var n=0,r=0;r<t.length;++r)n|=t[r]^e[r];return 0===n},this.setFavicon=function(t){var e=document.createElement("link");e.rel="Shortcut Icon",e.type="image/x-icon",e.href=t;for(var n=document.getElementsByTagName("head")[0],r=n.getElementsByTagName("link"),i=0;i<r.length;i++){var o=r[i];o.type==e.type&&o.rel==e.rel&&n.removeChild(o)}n.appendChild(e)},this.clear=function(t){if(t instanceof Array)for(var e=0;e<t.length;++e)t[e]=0},this.time=function(){var t=new Date,e="000"+t.getMilliseconds(),n=t.toTimeString().substring(0,8)+"."+e.substring(e.length-3);return n},this.fmt=function(t){return NFC.util.time()+" "+t},this.concat=function(t,e){var n,r=new Uint8Array(t.length+e.length),i=0;for(n=0;n<t.length;n++,i++)r[i]=t[n];for(n=0;n<e.length;n++,i++)r[i]=e[n];return r},this.log=function(){t&&console.log.apply(console,arguments)},this.debuggerOn=function(){t=!0},this.debuggerOff=function(){t=!1}}();